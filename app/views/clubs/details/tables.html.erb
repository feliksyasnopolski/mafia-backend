<%= turbo_frame_tag "club_settings" do %>
  <div class="row">
    <% @club.tables.each do |table| %>
      <div class="col-md-3" style="width: 20%;">
        <div class="card">
          <div class="card-header">
            <%= t('clubs.table_with_number', number: table.number) %>
          </div>
          <div class="card-body">
            <input type="text" hidden class="user-select-all" value="<%= broadcast_url(table.token) %>" />
            <p class="card-text">
              <button class="btn btn-primary copy-link" onclick="copyLink()" ><%= t('clubs.manage.tables.broadcast_link') %> </button>
            </p>
          </div>
        </div>
      </div>
    <% end %>
  </div> 
  <script>
  var codeExecuted = false;

  function copy(text) {
    return new Promise((resolve, reject) => {
        if (typeof navigator !== "undefined" && typeof navigator.clipboard !== "undefined" && navigator.permissions !== "undefined") {
            const type = "text/plain";
            const blob = new Blob([text], { type });
            const data = [new ClipboardItem({ [type]: blob })];
            navigator.permissions.query({name: "clipboard-write"}).then((permission) => {
                if (permission.state === "granted" || permission.state === "prompt") {
                    navigator.clipboard.write(data).then(resolve, reject).catch(reject);
                }
                else {
                    reject(new Error("Permission not granted!"));
                }
            });
        }
        else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
            var textarea = document.createElement("textarea");
            textarea.textContent = text;
            textarea.style.position = "fixed";
            textarea.style.width = '2em';
            textarea.style.height = '2em';
            textarea.style.padding = 0;
            textarea.style.border = 'none';
            textarea.style.outline = 'none';
            textarea.style.boxShadow = 'none';
            textarea.style.background = 'transparent';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand("copy");
                document.body.removeChild(textarea);
                resolve();
            }
            catch (e) {
                document.body.removeChild(textarea);
                reject(e);
            }
        }
        else {
            reject(new Error("None of copying methods are supported by this browser!"));
        }
    });   
  }

  function copyLink() {
    var text = $(".user-select-all").val();
    
    copy(text).then(() => {
        console.log("Copied to clipboard!");
    }, (e) => {
        console.error(e);
    });

  }

  // $("turbo:load", function() {
  //   if (!codeExecuted) {
  //     onLoad();
  //     codeExecuted = true;
  //   }
  // });
  </script>
<% end %>